# This will be sourced before launching a Singularity container.
# Any variables prefixed with "SINGULARITYENV_" will be transposed
# properly into the container. For example:
# SINGULARITYENV_LD_LIBRARY_PATH -> LD_LIBRARY_PATH

# Environment modules if set, cause errors in containers
unset module
unset ml

# Bash env has been known to cause issues in containers
unset BASH_ENV

# Some distributions don't have /bin and /sbin in PATH anymore
SINGULARITYENV_PATH="$PATH:/bin:/sbin:/usr/bin:/usr/sbin"

# Don't save the shell's HISTFILE
HISTFILE=""

export PATH HISTFILE

# This is an experimental snippet which is activated if the
# environment variable SINGULARITY_INCLUDEGPU is set.
if [ -n "${SINGULARITY_INCLUDEGPU:-}" ]; then
    for i in `ldconfig -p | grep -E 'libnv|libcuda'`; do
        if [ -f "$i" ]; then 
            N=`basename "$i"`
            message 2 "Including GPU lib: $N\n"
            if [ -z "${SINGULARITY_BINDPATH:-}" ]; then
                SINGULARITY_BINDPATH="$i:/.singularity.d/libs/$N"
            else
                SINGULARITY_BINDPATH="$i:/.singularity.d/libs/$N,$SINGULARITY_BINDPATH"
            fi
        fi
    done
    if [ -n "${SINGULARITY_BINDPATH:-}" ]; then
        export SINGULARITY_BINDPATH
    fi
fi

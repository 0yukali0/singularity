#!/bin/sh
# 
# Copyright (c) 2015, Gregory M. Kurtzer
# All rights reserved.
# 
# Copyright (c) 2015, The Regents of the University of California,
# through Lawrence Berkeley National Laboratory (subject to receipt of
# any required approvals from the U.S. Dept. of Energy).
# All rights reserved.
# 
# 

if [ -z "$libexecdir" ]; then
    echo "Could not identify the Singularity libexecdir."
    exit 1
fi

if [ -f "$libexecdir/singularity/functions" ]; then
    . "$libexecdir/singularity/functions"
else
    echo "Error loading functions: $libexecdir/singularity/functions"
    exit 1
fi


SAPPSPEC="$1"
SAPPFILE="$2"
export SAPPSPEC SAPPFILE

if [ -z "$SAPPSPEC" ]; then
    message 1 "SAPP specfile not given"
    exit 1
fi

if [ ! -f "$SAPPSPEC" ]; then
    message 1 "SAPP specfile not found"
    exit 1
fi

NAME=`get_key_from_conf "Name" $SAPPSPEC`
SUMMARY=`get_key_from_conf "Summary" $SAPPSPEC`
TMPDIR=`mktemp -d /tmp/.singularity.XXXXXXX`
export TMPDIR

if [ -n "$NAME" ]; then
    SAPPNAME=`echo "$NAME" | sed -e 's@ @_@g'`
else
    SAPPNAME=`basename $SAPPSPEC`
    NAME="$SAPPNAME"
fi

message 1 "Building '$NAME'"

message 2 "Working directory: $TMPDIR"


if [ -n "$SAPPFILE" ]; then
    if [ -d "$SAPPFILE" ]; then
        SAPPFILE=`echo "$SAPPFILE/$SAPPNAME.sapp" | sed -e 's@//@/@g'`
    else
        DIRNAME=`dirname "$SAPPFILE"`
        if [ ! -d "$DIRNAME" ]; then
            if ! mkdir -p "$DIRNAME"; then
                message 1 "Could not create output directory"
                exit 1
            fi
        fi
    fi
else
    SAPPFILE="$SAPPNAME.sapp"
fi

if ! touch "$SAPPFILE" 2>/dev/null; then
    echo "Could not create $SAPPFILE"
    exit 1
fi



echo "#!/usr/bin/env sapprun" > $SAPPFILE
echo "Name: $NAME" >> $SAPPFILE
echo "Summary: $SUMMARY" >> $SAPPFILE
echo "$HEADER_END" >> $SAPPFILE

for i in $libexecdir/singularity/build/[0-9]*; do
    if [ -x "$i" ]; then
        message 3 "Running: $i"
        sh "$i" "$@"
        EXITCODE="$?"
        if [ "$EXITCODE" -ne "0" ]; then
            message 1 "Error thrown from module: $i"
            message 1 "Quiting!"
            rm -f $SAPPFILE
            exit $EXITCODE
        fi
    else
        message 1 "Error locating module: $i"
        message 2 "Left tmpdir at $TMPDIR"
        rm -f $SAPPFILE
        exit 1
    fi

done

if [ -z "$DEBUG" ]; then
    rm -rf $TMPDIR
else
    message 5 "working directory at: $TMPDIR"
fi

exit $RETVAL

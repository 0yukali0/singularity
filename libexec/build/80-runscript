#!/bin/sh
# 
# Copyright (c) 2015, Gregory M. Kurtzer
# All rights reserved.
# 
# Copyright (c) 2015, The Regents of the University of California,
# through Lawrence Berkeley National Laboratory (subject to receipt of
# any required approvals from the U.S. Dept. of Energy).
# All rights reserved.
# 
# 

if [ -z "$libexecdir" ]; then
    echo "Could not identify the Singularity libexecdir."
    exit 1
fi

if [ -f "$libexecdir/singularity/functions" ]; then
    . "$libexecdir/singularity/functions"
else
    echo "Error loading functions: $libexecdir/singularity/functions"
    exit 1
fi

if [ -z "$SAPPSPEC" ]; then
    message 0 "SAPP specfile not given\n"
    exit 1
fi

if [ -z "$TMPDIR" ]; then
    message 0 "TMPDIR not given\n"
    exit 1
fi


message 5 "Building singularity runscript\n"
echo "#!/bin/sh" > "$TMPDIR/singularity"
echo "PATH=/bin:/usr/bin:/sbin:/usr/sbin" >> "$TMPDIR/singularity"
echo "export PATH" >> "$TMPDIR/singularity"
get_section_from_conf "runscript" "$SAPPSPEC" >> "$TMPDIR/singularity.runscript"

if [ -s "$TMPDIR/singularity.runscript" ]; then
    cat "$TMPDIR/singularity.runscript" >> "$TMPDIR/singularity"
else
    message 2 "generating a basic singularity runscript\n"
    if OUTPUT=`get_key_from_conf "exec" "$SAPPSPEC"`; then
        echo "exec \"$OUTPUT\" \"\$@\"" >> "$TMPDIR/singularity"
    else
        message 0 "ERROR: no runscript or program to exec defined!\n"
        exit 1
    fi
fi
rm -f "$TMPDIR/singularity.runscript"
chmod 755 "$TMPDIR/singularity"

exit 0

#!/bin/sh
#
# WARNING: This file will be executed by root on behalf of the user
# running it. Do not modify without being really really careful!

DEVICES="/dev/null /dev/random /dev/urandom /dev/zero"

if [ -z "$SAPPCONTAINER" ]; then
    echo "ERROR: SAPPCONTAINER is not defined"
    exit 255
fi

if [ ! -d "$SAPPCONTAINER" ]; then
    echo "ERROR: SAPPCONTAINER is not a directory"
    exit 255
fi

if [ -z "$SINGULARITY_UID" ]; then
    echo "ERROR: The Singularity user ID was not passed"
    exit 255
fi

if [ -z "$SINGULARITY_GID" ]; then
    echo "ERROR: The Singularity group ID was not passed"
    exit 255
fi


if [ ! -d "$SAPPCONTAINER/dev" ]; then
    if ! mkdir "$SAPPCONTAINER/dev" 2>/dev/null; then
        echo "ERROR: Could not create /dev tree"
        exit 1
    fi
fi

for dev in $DEVICES; do
    cp -a "$dev" "$SAPPCONTAINER/$dev"
done

chown -R "$SINGULARITY_UID"."$SINGULARITY_GID" "$SAPPCONTAINER/dev"

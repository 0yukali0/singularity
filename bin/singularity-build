#!/bin/sh


PROGRAM=$1
TMPDIR=`mktemp -d /tmp/singularity-build.XXXXXXXX`
INCLUDE="/bin/sh"


includefile() {
    for file in $@; do
        DIRNAME=`dirname $file`
        if [ ! -d "$TMPDIR/$DIRNAME" ]; then
            mkdir -p "$TMPDIR/$DIRNAME"
        fi
        cp -L "$file" "$TMPDIR/$file"
    done
}


includelddeps() {
    for file in $@; do
        ldd $file | sed -e 's@ @\n@g' | while read i; do
            if [ -f "$i" ]; then
                includefile $i
            fi
        done
    done
}

cleanup() {
    rm -rf $TMPDIR
}






if PROGRAM_BIN=`which $PROGRAM 2>/dev/null`; then
    PROGRAM_NAME=`basename $PROGRAM_BIN`

    includefile $PROGRAM_BIN
    includelddeps $PROGRAM_BIN

    includefile $INCLUDE
    includelddeps $INCLUDE

    echo "#!/bin/sh" > $TMPDIR/run
    echo "$PROGRAM_BIN \$@" >> $TMPDIR/run

    (cd $TMPDIR; find . | cpio -o --quiet -H newc ) | gzip -c9 > $PROGRAM_NAME.sapp

fi


cleanup
exit
